{% extends "base.html" %}

{% block title %}Shopping Cart - SHOP&SERV{% endblock %}

{% block content %}
<div class="container" style="padding: 2rem 20px;">
    <div class="dashboard-header">
        <h1>Shopping Cart</h1>
    </div>
    
    {% if cart_items or service_cart_items %}
        <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
            <div>
                {% if cart_items %}
                <h3 style="margin-bottom: 1rem;">Products</h3>
                {% for item in cart_items %}
                    <div class="card mb-3 fade-in">
                        <div style="display: grid; grid-template-columns: 150px 1fr auto; gap: 1.5rem; padding: 1.5rem; align-items: center;">
                            <div>
                                {% if item.product.image %}
                                    <img src="{{ url_for('static', filename='uploads/' ~ item.product.image) }}" alt="{{ item.product.name }}" style="width: 100%; border-radius: 8px;">
                                {% else %}
                                    <div style="width: 100%; height: 150px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem;">
                                        üì¶
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div>
                                <h3>{{ item.product.name }}</h3>
                                <p style="color: var(--gray);">{{ item.product.shop.name }}</p>
                                <p class="product-price">{{ item.product.price|format_currency }}</p>
                                
                                <div class="flex gap-2 mt-2">
                                    <input type="number" value="{{ item.quantity }}" min="1" max="{{ item.product.stock }}" 
                                           onchange="updateCartQuantity({{ item.id }}, this.value)"
                                           style="width: 80px; padding: 0.5rem; border: 2px solid var(--border); border-radius: 8px;">
                                    <button onclick="removeFromCart({{ item.id }})" class="btn btn-danger btn-sm">Remove</button>
                                </div>
                            </div>
                            
                            <div style="text-align: right;">
                                <p style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">
                                    {{ (item.product.price * item.quantity)|format_currency }}
                                </p>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                {% endif %}
                
                {% if service_cart_items %}
                <h3 style="margin-bottom: 1rem; margin-top: 2rem;">Services</h3>
                {% for item in service_cart_items %}
                    <div class="card mb-3 fade-in">
                        <div style="display: grid; grid-template-columns: 150px 1fr auto; gap: 1.5rem; padding: 1.5rem; align-items: center;">
                            <div>
                                {% if item.service.image %}
                                    <img src="{{ url_for('static', filename='uploads/' ~ item.service.image) }}" alt="{{ item.service.name }}" style="width: 100%; border-radius: 8px;">
                                {% else %}
                                    <div style="width: 100%; height: 150px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 2rem;">
                                        üõ†Ô∏è
                                    </div>
                                {% endif %}
                            </div>
                            
                            <div>
                                <h3>{{ item.service.name }}</h3>
                                <p style="color: var(--gray);">{{ item.service.shop.name }}</p>
                                {% if item.service.duration %}
                                <p style="color: var(--gray); font-size: 0.9rem;">‚è±Ô∏è {{ item.service.duration }}</p>
                                {% endif %}
                                <p class="product-price">{{ item.service.price|format_currency }}</p>
                                
                                <div class="flex gap-2 mt-2">
                                    <input type="number" value="{{ item.quantity }}" min="1" max="10" 
                                           onchange="updateServiceCartQuantity({{ item.id }}, this.value)"
                                           style="width: 80px; padding: 0.5rem; border: 2px solid var(--border); border-radius: 8px;">
                                    <button onclick="removeServiceFromCart({{ item.id }})" class="btn btn-danger btn-sm">Remove</button>
                                </div>
                            </div>
                            
                            <div style="text-align: right;">
                                <p style="font-size: 1.5rem; font-weight: bold; color: var(--primary);">
                                    {{ (item.service.price * item.quantity)|format_currency }}
                                </p>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                {% endif %}
            </div>
            
            <div>
                <div class="card" style="position: sticky; top: 100px;">
                    <div class="card-body">
                        <h3 class="mb-3">Order Summary</h3>
                        
                        <div class="mb-4">
                            <div class="flex-between mb-3">
                                <span>Subtotal:</span>
                                <span class="font-bold">{{ total|format_currency }}</span>
                            </div>
                            
                            <a href="{{ url_for('checkout') }}" class="btn btn-primary" style="width: 100%; padding: 0.75rem 1.5rem; font-weight: 600; font-size: 1.1rem;">
                                Proceed to Payment
                            </a>
                            
                            <a href="{{ url_for('products') }}" class="btn btn-outline mt-3" style="width: 100%; padding: 0.75rem 1.5rem; font-weight: 500; font-size: 1rem; border: 2px solid var(--primary);">
                                Continue Shopping
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% else %}
        <div class="card">
            <div class="card-body text-center" style="padding: 3rem;">
                <div style="font-size: 4rem; margin-bottom: 1rem;">üõí</div>
                <h2>Your cart is empty</h2>
                <p style="color: var(--gray); margin: 1rem 0;">Add some products to get started!</p>
                <a href="{{ url_for('products') }}" class="btn btn-primary">Browse Products</a>
            </div>
        </div>
    {% endif %}
</div>
{% endblock %}

<style>
    @media (max-width: 768px) {
        .container > div {
            grid-template-columns: 1fr !important;
        }
        .card > div {
            grid-template-columns: 1fr !important;
        }
    }
</style>

{% block extra_js %}
<script>
    async function updateCartQuantity(itemId, quantity) {
        try {
            const response = await fetch(`/cart/update/${itemId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ quantity: parseInt(quantity) })
            });
            
            const data = await response.json();
            
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            alert('An error occurred. Please try again.');
            console.error(error);
        }
    }
    
    async function removeFromCart(itemId) {
        if (!confirm('Remove this item from cart?')) {
            return;
        }
        
        try {
            const response = await fetch(`/cart/remove/${itemId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            alert('An error occurred. Please try again.');
            console.error(error);
        }
    }
    
    async function updateServiceCartQuantity(itemId, quantity) {
        try {
            const response = await fetch(`/cart/update-service/${itemId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                },
                body: JSON.stringify({ quantity: parseInt(quantity) })
            });
            
            const data = await response.json();
            
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            alert('An error occurred. Please try again.');
            console.error(error);
        }
    }
    
    async function removeServiceFromCart(itemId) {
        if (!confirm('Remove this service from cart?')) {
            return;
        }
        
        try {
            const response = await fetch(`/cart/remove-service/${itemId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCSRFToken()
                }
            });
            
            const data = await response.json();
            
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.message);
            }
        } catch (error) {
            alert('An error occurred. Please try again.');
            console.error(error);
        }
    }
</script>
{% endblock %}
