{% extends "base.html" %}

{% block title %}Checkout - SHOP&SERV{% endblock %}

{% block content %}
<!-- Terms and Conditions Modal -->
<div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="termsModalLabel">Terms and Conditions</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h4>Important Notice</h4>
                <p>By proceeding with your purchase, you agree to the following terms and conditions:</p>
                
                <h5>Return & Refund Policy</h5>
                <ul>
                    <li>All sales are final. No returns or exchanges are accepted after purchase.</li>
                    <li>Refunds will not be provided for any reason, including but not limited to change of mind, incorrect size/color selection, or product not meeting expectations.</li>
                    <li>In case of damaged or defective items, please contact customer support within 24 hours of delivery with photographic evidence.</n>                </ul>
                
                <h5>Order Processing</h5>
                <ul>
                    <li>Orders are typically processed within 1-2 business days.</li>
                    <li>Delivery times are estimates and not guaranteed.</li>
                </ul>
                
                <h5>Payment</h5>
                <ul>
                    <li>All payments are processed securely through our payment gateway.</li>
                    <li>By placing an order, you authorize us to charge the total amount to your selected payment method.</li>
                </ul>
                
                <div class="form-check mt-4">
                    <input class="form-check-input" type="checkbox" id="agreeTerms" required>
                    <label class="form-check-label" for="agreeTerms">
                        I have read and agree to the terms and conditions stated above
                    </label>
                    <div class="invalid-feedback">
                        You must agree to the terms and conditions to proceed.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmCheckout">Proceed to Payment</button>
            </div>
        </div>
    </div>
</div>

<div class="container" style="padding: 2rem 20px;">
    <div class="dashboard-header">
        <h1>Checkout</h1>
    </div>
    
    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem;">
        <div>
            <div class="card fade-in">
                <div class="card-body">
                    <h3 class="mb-3">Shipping Information</h3>
                    
                    {% with messages = get_flashed_messages(with_categories=true) %}
                        {% if messages %}
                            {% for category, message in messages %}
                                <div class="alert alert-{{ category }}">
                                    {{ message }}
                                </div>
                            {% endfor %}
                        {% endif %}
                    {% endwith %}
                    
                    <div id="form-errors" class="alert alert-danger d-none mb-4" role="alert"></div>

                    <form id="checkoutForm" method="POST" action="{{ url_for('checkout') }}" onsubmit="return handleFormSubmission(event)" novalidate>
                        {% if csrf_token %}
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        {% endif %}
                        
                        <!-- Error message container -->
                        <div id="form-errors" class="alert alert-danger d-none"></div>
                        
                        <div class="form-group mb-3">
                            <label class="form-label">Delivery Address <span class="text-danger">*</span></label>
                            <textarea name="shipping_address" class="form-control" rows="2" placeholder="Enter your delivery address" required>123 Demo Street, Demo City</textarea>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Contact Phone <span class="text-danger">*</span></label>
                                <input type="tel" name="shipping_phone" class="form-control" value="+1234567890" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Payment Method <span class="text-danger">*</span></label>
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="payment_method" id="online_payment" value="online" required>
                                    <label class="form-check-label fw-bold" for="online_payment">
                                        Pay with QR Code
                                    </label>
                                    <div id="qrCodeSection" class="mt-3 p-3 bg-light rounded" style="display: none;">
                                        <p class="small mb-2">Scan this QR code to make payment:</p>
                                        <div class="text-center">
                                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=upi://pay?pa=6351074394@upi&pn=Shop%20Owner&mc=1234&tid=DEMO1234&tr=DEMO123456789&tn=Payment%20for%20Order" 
                                                 alt="Payment QR Code" class="img-fluid" style="max-width: 200px; border: 1px solid #ddd; padding: 5px; background: white;">
                                            <p class="small mt-2 mb-1"><strong>UPI ID:</strong> 6351074394@upi</p>
                                            <p class="small text-muted">Order will be confirmed after payment</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="payment_method" id="cod" value="cod">
                                    <label class="form-check-label" for="cod">
                                        Cash on Delivery
                                    </label>
                                </div>
                                <div class="invalid-feedback">Please select a payment method.</div>
                            </div>
                            <input type="hidden" name="terms_accepted" id="terms_accepted" value="false">
                        </div>
                        <div class="form-group mb-4">
                            <label class="form-label">Special Instructions (optional)</label>
                            <textarea name="notes" class="form-control" rows="2" placeholder="Any special delivery instructions or notes for the shop"></textarea>
                        </div>
                        
                        <div class="form-check mb-4">
                            <input type="checkbox" class="form-check-input" id="agreeTerms" name="terms_accepted" value="accepted" required>
                            <label class="form-check-label" for="agreeTerms">
                                I agree to the <a href="#" data-bs-toggle="modal" data-bs-target="#termsModal">Terms and Conditions</a>
                            </label>
                            <div class="invalid-feedback">You must agree to the terms and conditions.</div>
                        </div>
                        
                        <button type="button" class="btn btn-primary btn-lg w-100" id="continue-button">
                            <i class="fas fa-credit-card me-2"></i>Continue to Payment
                        </button>
                        <button type="submit" class="btn btn-success btn-lg w-100 d-none" id="place-order-button">
                            <i class="fas fa-check-circle me-2"></i>Place Order
                        </button>
                        
                        <!-- Terms and Conditions Modal -->
                        <div class="modal fade" id="termsModal" tabindex="-1" aria-labelledby="termsModalLabel" aria-hidden="true">
                            <div class="modal-dialog modal-dialog-scrollable">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="termsModalLabel">Terms and Conditions</h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                    </div>
                                    <div class="modal-body">
                                        <h6>1. Order Acceptance</h6>
                                        <p>Your placement of an order through our site constitutes an offer to purchase the products or services listed in your order.</p>
                                        
                                        <h6>2. Pricing and Payment</h6>
                                        <p>All prices are in INR (Indian Rupee) and are subject to change without notice. You agree to pay all charges that may be incurred by you or on your behalf through the site.</p>
                                        
                                        <h6>3. Shipping and Delivery</h6>
                                        <p>We will arrange for shipment of the products to you. Please check the individual product page for specific delivery options.</p>
                                        
                                        <h6>4. Returns and Refunds</h6>
                                        <p>Please review our return policy for information about returning products and obtaining refunds.</p>
                                        
                                        <h6>5. Limitation of Liability</h6>
                                        <p>We shall not be liable for any indirect, incidental, special, consequential, or punitive damages resulting from your use of or inability to use the site or services.</p>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                        <button type="button" class="btn btn-primary" id="confirmCheckout">I Agree & Continue</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <div>
            <div class="card" style="position: sticky; top: 100px;">
                <div class="card-body">
                    <h3 class="mb-3">Order Summary</h3>
                    
                    {% if cart_items %}
                    <h4 style="font-size: 1rem; margin-top: 1rem; color: var(--gray);">Products</h4>
                    {% for item in cart_items %}
                        <div class="flex-between mb-2">
                            <span>{{ item.product.name }} x{{ item.quantity }}</span>
                            <span>{{ (item.product.price * item.quantity)|format_currency }}</span>
                        </div>
                    {% endfor %}
                    {% endif %}
                    
                    {% if service_cart_items %}
                    <h4 style="font-size: 1rem; margin-top: 1rem; color: var(--gray);">Services</h4>
                    {% for item in service_cart_items %}
                        <div class="flex-between mb-2">
                            <span>{{ item.service.name }} x{{ item.quantity }}</span>
                            <span>{{ (item.service.price * item.quantity)|format_currency }}</span>
                        </div>
                    {% endfor %}
                    {% endif %}
                    
                    <hr style="margin: 1rem 0; border: none; border-top: 1px solid var(--border);">
                    
                    <div class="flex-between mb-3">
                        <strong>Total:</strong>
                        <strong style="font-size: 1.5rem; color: var(--primary);">{{ total|format_currency }}</strong>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification container -->
<div id="notification" class="notification" style="display: none;"></div>

<style>
.notification {
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 15px 25px;
    border-radius: 5px;
    color: white;
    z-index: 1000;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    opacity: 0;
    transform: translateY(-20px);
    transition: opacity 0.3s, transform 0.3s;
}
.notification.show {
    opacity: 1;
    transform: translateY(0);
}
.notification.success {
    background-color: #28a745;
}
.notification.error {
    background-color: #dc3545;
}
.notification.warning {
    background-color: #ffc107;
    color: #000;
}
</style>

<script>
    // Show notification function
    function showNotification(message, type = 'success') {
        const notification = document.getElementById('notification');
        if (!notification) return;
        
        notification.textContent = message;
        notification.className = `notification ${type} show`;
        
        // Hide after 3 seconds
        setTimeout(() => {
            notification.classList.remove('show');
        }, 3000);
    }

    function handleFormSubmission(e) {
        e.preventDefault();
        
        const form = document.getElementById('checkoutForm');
        const formData = new FormData(form);
        const submitButton = document.activeElement;
        const errorContainer = document.getElementById('form-errors');
        
        // Determine which button was clicked
        const isPlaceOrderButton = submitButton && submitButton.id === 'place-order-button';
        const buttonToDisable = isPlaceOrderButton ? 
            document.getElementById('place-order-button') : 
            document.getElementById('continue-button');
            
        const originalButtonText = buttonToDisable ? buttonToDisable.innerHTML : '';
        
        // Reset error state
        errorContainer.classList.add('d-none');
        
        // Show loading state
        if (buttonToDisable) {
            buttonToDisable.disabled = true;
            buttonToDisable.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
            
            // Re-enable button if form submission fails
            setTimeout(() => {
                if (buttonToDisable.disabled) {
                    buttonToDisable.disabled = false;
                    buttonToDisable.innerHTML = originalButtonText;
                }
            }, 10000); // Re-enable after 10 seconds if no response
        }
        
        // Convert FormData to URLSearchParams for better compatibility
        const params = new URLSearchParams();
        for (const [key, value] of formData.entries()) {
            params.append(key, value);
        }
        
        // Submit form via AJAX
        fetch(form.action, {
            method: 'POST',
            body: params,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'Accept': 'application/json',
                'Content-Type': 'application/x-www-form-urlencoded',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]')?.value
            },
            credentials: 'same-origin'
        })
        .then(response => response.json().then(data => {
            if (!response.ok) {
                throw new Error(data.error || 'Server error');
            }
            return data;
        }))
        .then(data => {
            console.log('Response data:', data);
            if (data.redirect) {
                // Show success message before redirect
                showNotification('Order placed successfully!', 'success');
                setTimeout(() => {
                    window.location.href = data.redirect;
                }, 1500);
            } else if (data.error) {
                throw new Error(data.error);
            } else if (data.success) {
                // If successful but no redirect, reload the page
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('Error:', error);
            const errorMessage = error.message || 'An error occurred. Please try again.';
            errorContainer.textContent = errorMessage;
            errorContainer.classList.remove('d-none');
            showNotification(errorMessage, 'danger');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        })
        .finally(() => {
            // Always re-enable the button
            if (buttonToDisable) {
                buttonToDisable.disabled = false;
                buttonToDisable.innerHTML = originalButtonText;
            }
        });
        
        return false;
    }
    
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('checkoutForm');
        const continueButton = document.getElementById('continue-button');
        const placeOrderButton = document.getElementById('place-order-button');
        const errorContainer = document.getElementById('form-errors');
        const qrSection = document.getElementById('qrCodeSection');
        const termsModal = new bootstrap.Modal(document.getElementById('termsModal'));
        const onlinePaymentRadio = document.getElementById('online_payment');
        const codRadio = document.getElementById('cod');
        
        // Initialize QR code section as hidden
        if (qrSection) qrSection.style.display = 'none';
        
        // Handle continue button click
        if (continueButton) {
            continueButton.addEventListener('click', function() {
                // Validate form
                if (!form.checkValidity()) {
                    form.classList.add('was-validated');
                    return;
                }
                
                // Show QR code if online payment is selected
                if (onlinePaymentRadio && onlinePaymentRadio.checked) {
                    if (qrSection) qrSection.style.display = 'block';
                    if (continueButton) continueButton.classList.add('d-none');
                    if (placeOrderButton) placeOrderButton.classList.remove('d-none');
                } else {
                    // If COD is selected, submit the form directly
                    form.dispatchEvent(new Event('submit'));
                }
            });
        }
        
        // Handle place order button click
        if (placeOrderButton) {
            placeOrderButton.addEventListener('click', function() {
                form.dispatchEvent(new Event('submit'));
            });
        }
        
        // Handle payment method change
        if (onlinePaymentRadio && codRadio) {
            [onlinePaymentRadio, codRadio].forEach(radio => {
                radio.addEventListener('change', function() {
                    if (qrSection) {
                        qrSection.style.display = (this.value === 'online') ? 'block' : 'none';
                    }
                });
            });
        }
        
        // Toggle QR code visibility when payment method changes
        document.querySelectorAll('input[name="payment_method"]').forEach(radio => {
            // Set initial state
            if (radio.checked) {
                qrSection.style.display = radio.value === 'online' ? 'block' : 'none';
            }
            
            radio.addEventListener('change', function() {
                qrSection.style.display = this.value === 'online' ? 'block' : 'none';
            });
        });
        
        // Handle form submission
        if (form) {
            form.addEventListener('submit', function(e) {
                const selectedPayment = document.querySelector('input[name="payment_method"]:checked');
                if (!selectedPayment) {
                    e.preventDefault();
                    alert('Please select a payment method');
                    return false;
                }
                
                // Show loading state
                if (checkoutButton) {
                    checkoutButton.disabled = true;
                    const originalText = checkoutButton.innerHTML;
                    checkoutButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Processing...';
                    
                    // Re-enable button if form submission fails
                    setTimeout(() => {
                        checkoutButton.disabled = false;
                        checkoutButton.innerHTML = originalText;
                    }, 10000); // Re-enable after 10 seconds if no response
                }
                
                return true;
            });
        }
        
        // Show terms modal when clicking the terms link
        document.querySelectorAll('[data-bs-toggle="modal"]').forEach(element => {
            element.addEventListener('click', function(e) {
                if (this.getAttribute('data-bs-target') === '#termsModal') {
                    e.preventDefault();
                    termsModal.show();
                }
            });
        });
        
        // Function to handle form submission
        function handleFormSubmission(e) {
            e.preventDefault();
            
            // Reset any previous states
            form.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            if (errorContainer) errorContainer.classList.add('d-none');
            
            // Check payment method is selected
            const paymentMethod = form.querySelector('select[name="payment_method"]');
            if (!paymentMethod || !paymentMethod.value) {
                paymentMethod.classList.add('is-invalid');
                if (errorContainer) {
                    errorContainer.textContent = 'Please select a payment method.';
                    errorContainer.classList.remove('d-none');
                }
                return false;
            }
            
            // Check terms acceptance
            const termsCheckbox = document.getElementById('agreeTerms');
            if (!termsCheckbox || !termsCheckbox.checked) {
                if (termsCheckbox) termsCheckbox.classList.add('is-invalid');
                const termsModal = new bootstrap.Modal(document.getElementById('termsModal'));
                termsModal.show();
                if (termsCheckbox) termsCheckbox.scrollIntoView({ behavior: 'smooth', block: 'center' });
                return false;
            }
            
            // Validate other required fields
            let isValid = true;
            const missingFields = [];
            
            form.querySelectorAll('[required]').forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                    
                    // Get field label for error message
                    const label = form.querySelector(`label[for="${field.id}"]`);
                    const fieldName = label ? label.textContent.trim().replace('*', '') : 'This field';
                    missingFields.push(fieldName);
                }
            });
            
            if (!isValid) {
                if (errorContainer) {
                    errorContainer.textContent = `Please fill in the following required fields: ${missingFields.join(', ')}`;
                    errorContainer.classList.remove('d-none');
                }
                
                // Scroll to first invalid field
                const firstInvalid = form.querySelector('.is-invalid');
                if (firstInvalid) {
                    firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                
                return false;
            }
            
            // Show processing state
            if (checkoutButton) {
                checkoutButton.disabled = true;
                checkoutButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
            }
            
            // Show processing state
            if (checkoutButton) {
                checkoutButton.disabled = true;
                const originalText = checkoutButton.innerHTML;
                checkoutButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
                
                // Revert button state after 5 seconds if form doesn't submit
                setTimeout(() => {
                    if (checkoutButton.disabled) {
                        checkoutButton.disabled = false;
                        checkoutButton.innerHTML = originalText;
                        if (errorContainer) {
                            errorContainer.textContent = 'Submission timed out. Please try again.';
                            errorContainer.classList.remove('d-none');
                        }
                    }
                }, 5000);
            }
            
            // Prepare form data
            const formData = new FormData(form);
            
            // Ensure terms_accepted is set to true if checkbox is checked
            if (termsCheckbox && termsCheckbox.checked) {
                formData.set('terms_accepted', 'true');
            }
            
            // Debug log
            console.log('Form data:', Object.fromEntries(formData.entries()));
            
            // Submit the form using fetch
            fetch('{{ url_for("checkout") }}', {
                method: 'POST',
                body: new URLSearchParams([...formData]),
                headers: {
                    'X-Requested-With': 'XMLHttpRequest',
                    'Accept': 'application/json',
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                credentials: 'same-origin'
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                console.log('Server response:', data);
                if (data.redirect) {
                    // If the server returns a redirect URL, navigate to it
                    window.location.href = data.redirect;
                } else if (data.error) {
                    // Show error message
                    if (errorContainer) {
                        errorContainer.textContent = data.error;
                        errorContainer.classList.remove('d-none');
                        // Scroll to error message
                        errorContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                } else {
                    // If no redirect but also no error, assume success
                    window.location.href = '/orders';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                if (errorContainer) {
                    errorContainer.textContent = 'An error occurred while processing your request. Please try again.';
                    errorContainer.classList.remove('d-none');
                }
                // Re-enable the button
                if (checkoutButton) {
                    checkoutButton.disabled = false;
                    checkoutButton.innerHTML = 'Place Order';
                }
            });
            
            return false;
        }
        
        // Handle form submission
        if (form) {
            form.addEventListener('submit', handleFormSubmission);
        }
        
        // Handle confirm button in modal
        const confirmButton = document.getElementById('confirmCheckout');
        if (confirmButton) {
            confirmButton.addEventListener('click', function() {
                // Check the terms checkbox
                termsCheckbox.checked = true;
                termsCheckbox.classList.remove('is-invalid');
                
                // Close the modal
                termsModal.hide();
                
                // Submit the form after a small delay to let the modal close
                setTimeout(() => {
                    form.dispatchEvent(new Event('submit'));
                }, 100);
            });
        }
        
        // Reset invalid state when checkbox is clicked
        if (termsCheckbox) {
            termsCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    this.classList.remove('is-invalid');
                }
            });
        }
        
        // Handle modal hidden event to reset form if user closes without accepting
        if (termsModal) {
            termsModal.addEventListener('hidden.bs.modal', function () {
                if (!termsCheckbox.checked) {
                    const termsAccepted = document.getElementById('termsAccepted');
                    if (termsAccepted) termsAccepted.value = 'n';
                    
                    if (checkoutButton) {
                        checkoutButton.disabled = false;
                        checkoutButton.innerHTML = 'Continue to Payment';
                    }
                }
            });
        }
        
        // Add input event listeners to remove invalid class when user starts typing
        const inputs = form.querySelectorAll('input, textarea, select');
        inputs.forEach(input => {
            input.addEventListener('input', function() {
                if (this.value.trim()) {
                    this.classList.remove('is-invalid');
                }
            });
        });
    });
</script>

<style>
    @media (max-width: 768px) {
        .container > div {
            grid-template-columns: 1fr !important;
        }
    }
</style>
{% endblock %}
